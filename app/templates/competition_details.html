{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

{% if session %}
{% if session.get('role') == 'voters' %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/voters.css') }}">
{% elif session.get('role') == 'scrutineer' %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scrutineer.css') }}">
{% elif session.get('role') == 'admin' %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endif %}
{% endif %}

<div class="container">
    <div class="list-group">
        {% if competition %}
        {% for competition_id, comp in competition.items() %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h1 class="card-title">{{ comp.competition_title }}</h1>
                <p><strong>Category:</strong> {{ comp.competition_category }}</p>
                <p><strong>Description:</strong> {{ comp.competition_description }}</p>

                <!-- Results Display -->
                {% if not comp.is_ongoing and comp.result_finalised %}
                <div class="row mb-2">
                    <div class="col-md-4">
                        <p><strong>Total Votes:</strong> {{ comp.total_votes }}</p>
                    </div>
                </div>
                <div class="row mb-2">
                    {% for winner in comp.winners %}
                    <div class="col-md-6">
                        <strong>Winner:</strong> {{ winner.competitor_name }} <i class="fas fa-crown"
                            style="color: gold;"></i>
                    </div>
                    <div class="col-md-6">
                        <strong>Winning Share:</strong> {{ (winner.votes_quantity / comp.total_votes * 100) | round(2)
                        }}%
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Countdown Timer -->
                <div class="d-flex justify-content-between align-items-center">
                    <p class="mb-0 me-3">
                        <strong>From:</strong>
                        <span id="start-time" data-time="{{ comp['start_date'].isoformat() }}">{{
                            comp['start_date'].strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    </p>
                    <p class="mb-0">
                        <strong>Time:</strong>
                        <span id="countdown"></span>
                    </p>
                </div>
                <p class="mb-0 me-3 my-2">
                    <strong>End:</strong>
                    <span id="end-time" data-time="{{ comp['end_date'].isoformat() }}">{{
                        comp['end_date'].strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </p>
            </div>
        </div>

        <div class="mt-4">
            <form id="vote-form" action="{{ url_for('submit_vote')}}" method="post">
                <input type="hidden" name="competition_id" value="{{ competition_id }}">
                <input type="hidden" name="competitor_id" value=""> <!-- Added hidden input field -->

                {% if comp.is_ongoing and user_role == 'voter' and not comp.user_has_voted %}
                <div class="row mb-4">
                    <div class="col-md-12 text-center">
                        <p class="mt-3 mb-0 p-3 text-center bg-light border rounded">
                            You can only vote for one competitor in this competition. Select your preferred competitor
                            below.
                        </p>
                    </div>
                </div>
                <!-- Submit Button Moved Here -->
                <div class="row mb-4">
                    <div class="col-md-12 text-right">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                    </div>
                </div>
                {% elif comp.is_ongoing and user_role == 'voter' and comp.user_has_voted %}
                <div class="text-center">
                    <p class="mt-3" style="font-size: large; background-color: azure;">You have already voted for this
                        competition.</p>
                    {% if voted_competitor_name %}
                    <p class="mt-3" style="font-size: large; background-color: azure;">You voted for {{
                        voted_competitor_name }}!</p>
                    {% endif %}
                </div>
                {% endif %}

                <div class="row mt-3">
                    {% for competitor in comp.competitors %}
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm"
                            style="{% if user_voted == competitor.competitor_id %}background-color: lightyellow;{% endif %}">
                            <div class="image-container" style="overflow: hidden; padding: 0; margin: 20px 0;">
                                <img src="{{ url_for('static', filename='competitor_images/' + competitor.competitor_image) }}"
                                    class="card-img-top" alt="{{ competitor.competitor_name }}"
                                    style="width: 200px; height: 150px; object-fit: cover;">
                            </div>

                            <div class="card-body text-center">
                                <h5 class="card-title d-flex justify-content-between align-items-center">
                                    {{ competitor.competitor_name }}
                                    {% if user_role == "admin" or user_role == "scrutineer" %}
                                    <span class="badge bg-info text-dark" style="font-size: small;">
                                        Votes: {{ competitor.votes_quantity }}
                                    </span>
                                    {% endif %}
                                </h5>

                                <button class="btn btn-link toggle-description" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#competitorCollapse{{ competitor.competitor_id }}"
                                    aria-expanded="false"
                                    aria-controls="competitorCollapse{{ competitor.competitor_id }}"
                                    aria-label="Toggle description for {{ competitor.competitor_name }}">
                                    <span class="arrow-down"></span>
                                </button>

                                <div class="collapse" id="competitorCollapse{{ competitor.competitor_id }}">
                                    <div class="card card-body">
                                        <h6>{{ competitor.competitor_description }}</h6>
                                    </div>
                                </div>

                                {% if comp.is_ongoing and user_role == 'voter' %}
                                <div class="d-flex justify-content-center mb-3; margin: 20px 0;">
                                    <button type="button"
                                        class="btn vote-btn {% if user_vote == competitor.competitor_id %}btn-success{% else %}btn-outline-primary{% endif %}"
                                        data-competitor-id="{{ competitor.competitor_id }}" {% if comp.user_has_voted
                                        %}disabled{% endif %}> <!-- Disabled if user has already voted -->
                                        Vote
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-info" role="alert">
            No competition found.
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        {% if vote_submitted %}
        <div class="alert alert-success mt-4" role="alert">
            Your vote for {{ voted_competitor_name }} has been successfully submitted!
        </div>
        {% endif %}

    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Your Vote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmVoteButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Update countdown
        function updateCountdown() {
            const now = new Date();
            const endTime = new Date(document.getElementById('end-time').getAttribute('data-time'));
            const countdownElement = document.getElementById('countdown');

            const diff = endTime - now;

            if (diff <= 0) {
                countdownElement.textContent = `Election ended on ${endTime.toLocaleString()}`;
                return;
            }

            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const hours = Math.floor((diff / 1000 / 60 / 60) % 24);
            const days = Math.floor(diff / 1000 / 60 / 60 / 24);

            countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s remaining`;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);

        // Toggle arrow rotation
        document.querySelectorAll('.toggle-description').forEach(button => {
            button.addEventListener('click', function () {
                const arrow = this.querySelector('.arrow-down');
                arrow.classList.toggle('rotate');
            });
        });

        // Handle vote button click
        const voteButtons = document.querySelectorAll('.vote-btn');
        voteButtons.forEach(button => {
            button.addEventListener('click', function () {
                // Remove 'btn-success' class from all buttons
                voteButtons.forEach(btn => btn.classList.remove('btn-success'));
                // Add 'btn-success' class to the clicked button
                this.classList.add('btn-success');
                // Update hidden input with the selected competitor ID
                const competitorId = this.getAttribute('data-competitor-id');
                const form = this.closest('form');
                form.querySelector('input[name="competitor_id"]').value = competitorId;
            });
        });

        // Handle form submission with confirmation
        const form = document.getElementById('vote-form');
        const submitButton = document.getElementById('submit-button');
        submitButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent form from submitting immediately

            const competitorId = form.querySelector('input[name="competitor_id"]').value;

            if (competitorId) {
                // Display confirmation message with competitor name
                const competitorName = document.querySelector('.vote-btn.btn-success').closest('.card-body').querySelector('.card-title').textContent;
                const confirmationMessage = `You have selected ${competitorName}. Do you want to submit your vote?`;
                document.getElementById('confirmationMessage').textContent = confirmationMessage;

                // Show confirmation modal
                const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmationModal.show();
            } else {
                alert('Please select a competitor before submitting your vote.');
            }
        });

        // Handle confirmation of the vote
        const confirmVoteButton = document.getElementById('confirmVoteButton');
        confirmVoteButton.addEventListener('click', function () {
            const form = document.getElementById('vote-form');
            form.submit();
        });

        // Highlight previously selected vote button
        const votedCompetitorId = "{{ voted_competitor_id }}";
        if (votedCompetitorId) {
            voteButtons.forEach(btn => {
                if (btn.getAttribute('data-competitor-id') === votedCompetitorId) {
                    btn.classList.add('btn-primary');
                }
            });
        }
    });
</script>
{% endblock %}